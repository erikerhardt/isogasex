---
title: "isogasex: Isotopic Gas Exchange"
subtitle: "R package documentation for TDL and Licor data processing"
author: "Erik B. Erhardt and David T. Hanson"
date: "`r format(Sys.time(), '%B %d, %Y')`"
header-includes:
   - \usepackage{amsmath,wasysym,undertilde}
output:
  rmarkdown::html_vignette:
    fig_caption: yes
    toc: yes
    toc_depth: 5
    number_sections: true
  html_document:
    toc: yes
    toc_depth: 5
    number_sections: false
    code_folding: hide
  pdf_document:
    latex_engine: xelatex
    toc: yes
    toc_depth: 5
    number_sections: true
vignette: >
  %\VignetteIndexEntry{isogasex: Isotopic Gas Exchange}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography:
  EE_BayesCO2.bib
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

<!---
# Erik's compile commands in R:
  rm(list=ls())
  #dev.off(dev.list()["RStudioGD"])  # close all plots
  fn.this <- "isogasex_user_guide.Rmd"
  setwd("C:/Dropbox/StatAcumen/consult/Authorship/2009_DavidHanson_Isotopes/R-package/isogasex/vignettes")
  library(knitr)
  knitr::purl(fn.this)
  rmarkdown::render(fn.this)
-->

```{r ch_01, echo=FALSE}
knitr::opts_chunk$set(comment = NA, message = FALSE, warning = FALSE, width = 100)
knitr::opts_chunk$set(fig.align = "center", fig.height = 4, fig.width = 6)
#knitr::opts_chunk$set(echo = FALSE)
#knitr::opts_chunk$set(cache = TRUE, autodep=TRUE)  #$
knitr::opts_chunk$set(cache = TRUE) #, autodep=TRUE)  #$
```

%
%  eedefs.tex     Erik B. Erhardt
%
%  This is the common command definitions for my thesis.
%

% font commands
\newcommand{\defin}{\bf}
%\renewcommand{\vector}{\utilde}
\renewcommand{\vector}{} % \mathbf
\renewcommand{\matrix}{\mathbf}
\renewcommand{\permil}{‰}
\renewcommand{\circ}{°}

%\newcommand{\Normal}          {\mathcal{N}}
\newcommand{\Normal}          {\textrm{Normal}}
\newcommand{\Wishart}         {\textrm{Wishart}} %{\mathcal{W}}
\newcommand{\IWishart}        {\textrm{Inv-Wishart}}
\newcommand{\Chisq}           {\textrm{scaled-$\chi^2$}} %{\mathcal{W}}
\newcommand{\IChisq}          {\textrm{Scaled-inv-$\chi^2$}}
%\newcommand{\Dirichlet}       {\mathcal{D}\textrm{ir}}
\newcommand{\Dirichlet}       {\textrm{Dirichlet}}
\newcommand{\dBeta}           {\textrm{Beta}}
\newcommand{\dGamma}          {\textrm{Gamma}}
\newcommand{\dIGamma}         {\textrm{Inv-Gamma}}
\newcommand{\Uniform}         {\textrm{Uniform}}

\newcommand{\transpose}       {\top}%             for matrix transpose

%% tdllicor begin %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\tdllicor}{\texttt{tdllicor}}

\newcommand{\data}[1]{\tilde{#1}} % data notation
\newcommand{\sdatasig}[1]{\sigma_{#1}^2} % data notation
\newcommand{\vdatasig}[1]{\Sigma_{#1}} % data notation

\newcommand{\subctpr}{}%{ctpr} % subscript notation ctpr
\newcommand{\subctp} {}%{ctp}  % subscript notation ctp
\newcommand{\subct}  {}%{ct}   % subscript notation ct
\newcommand{\subc}   {}%{c}    % subscript notation ct
\newcommand{\subt}   {}%{t}    % subscript notation  t


% CO2 variable definitions
% dot indicates a constant
\newcommand{\sdotab}{\dot{a}_{\textrm{b}}} % boundary
\newcommand{\sdota}{\dot{a}} % stomata
\newcommand{\sdotaw}{\dot{a}_{\textrm{w}}} % water
\newcommand{\sdotal}{\dot{a}_{\textrm{l}}} % water (same as \sdotaw)
\newcommand{\sdotbs}{\dot{b}_{\textrm{s}}} % CO2 entering solution at 20oC
\newcommand{\sdotb}{\dot{b}} % internal conductance vai gm
\newcommand{\sdotRstd}{\dot{R}_\textrm{std 13C}} % C ratio of standard
\newcommand{\sdotkappaHtw}{\dot{\kappa}_{\textrm{H}12}} % concentration constants for high tanks
\newcommand{\sdotkappaHth}{\dot{\kappa}_{\textrm{H}13}} % concentration constants for high tanks
\newcommand{\sdotkappaLtw}{\dot{\kappa}_{\textrm{L}12}} % concentration constants for low  tanks
\newcommand{\sdotkappaLth}{\dot{\kappa}_{\textrm{L}13}} % concentration constants for low  tanks
\newcommand{\vdotkappaHtw}{\vector{\dot{\kappa}}_{\textrm{H}}} % vectors of concentration constants
\newcommand{\vdotkappaLtw}{\vector{\dot{\kappa}}_{\textrm{L}}} % vectors of concentration constants
\newcommand{\sdotfthC}{\dot{f}_{\textrm{13C}}} % fraction of C isotopologues not measured

% Discrimination
\newcommand{\sDeltacomp}{\Delta_{\textrm{comp}\subct}} % Discrimination, comprehensive model
\newcommand{\sDeltaobs}{\Delta_{\textrm{obs}\subct}} % Discrimination, observed
\newcommand{\sDeltapred}{\Delta_{\textrm{pred}\subct}} % Discrimination, predicted, also Delta_i

% pressures
\newcommand{\spa}{p_{\textrm{a}\subct}} %
\newcommand{\sps}{p_{\textrm{s}\subct}} %
\newcommand{\spi}{p_{\textrm{i}\subct}} %
\newcommand{\spc}{p_{\textrm{c}\subct}} %
\newcommand{\spatmL}{p_{\textrm{atm}\subctp}} % Licor atmospheric pressure
\newcommand{\sallpressures}{\pi_{\subctp}}
 % data
 \newcommand{\sdatapatmL}{\data{p}_{\textrm{atm}\subctpr}} % Licor atmospheric pressure
 \newcommand{\ssigpatmL}{\sdatasig{p_{\textrm{atm}}}} % Licor atmospheric pressure

% respiration
\newcommand{\sse}{e_{\subt}} %
\newcommand{\sseprime}{e_{\subt}^{\prime}} %
\newcommand{\sRd}{R_{\textrm{d}\subt}} %
 % data
 \newcommand{\sdataRd}{\data{R}_{\textrm{d}\subctp}} %
 \newcommand{\ssigRd}{\sdatasig{R_{\textrm{d}}}}%\subct}}} %
\newcommand{\ssk}{k_{\subt}} %
 % data
 \newcommand{\sdatak}{\data{k}_{\subctp}} %
 \newcommand{\ssigk}{\sdatasig{k_{\subct}}} %
\newcommand{\ssf}{f_{\subct}} %
\newcommand{\ssfprime}{f_{\subct}^{\prime}} %
\newcommand{\sGammastar}{\Gamma^{\ast}_{\subt}} %
 % data
 \newcommand{\sdataGammastar}{\data{\Gamma}^{\ast}_{\subt}} %
 \newcommand{\ssigGammastar}{\sdatasig{\Gamma^{\ast}_{}}}%\subct}}} %

% isotope ratios
\newcommand{\sxi}{\xi_{\subctp}} %
\newcommand{\sdeltao}{\delta_{\textrm{o}\subctp}} %
\newcommand{\sdeltae}{\delta_{\textrm{e}\subctp}} %

% concentrations
\newcommand{\sCa}{C_{\textrm{a}\subctp}} %
\newcommand{\sCo}{C_{\textrm{o}\subctp}} % same as Ca
\newcommand{\sCs}{C_{\textrm{s}\subctp}} %
\newcommand{\sCi}{C_{\textrm{i}\subctp}} %
\newcommand{\sCe}{C_{\textrm{e}\subctp}} %
% high and low tanks
\newcommand{\skappaHtw}{\kappa_{\textrm{H}12\subctp}} % concentration constants for high tanks
\newcommand{\skappaHth}{\kappa_{\textrm{H}13\subctp}} % concentration constants for high tanks
\newcommand{\skappaLtw}{\kappa_{\textrm{L}12\subctp}} % concentration constants for low  tanks
\newcommand{\skappaLth}{\kappa_{\textrm{L}13\subctp}} % concentration constants for low  tanks
\newcommand{\vkappaH}{\vector{\kappa}_{\textrm{H}\subctp}} % vectors of concentration constants
\newcommand{\vkappaL}{\vector{\kappa}_{\textrm{L}\subctp}} % vectors of concentration constants
% ref and chamber
\newcommand{\skappaRtw}{\kappa_{\textrm{R}12\subc}} % concentration constants for high tanks
\newcommand{\skappaRth}{\kappa_{\textrm{R}13\subc}} % concentration constants for high tanks
\newcommand{\skappaCtw}{\kappa_{\textrm{C}12\subctp}} % concentration constants for low  tanks
\newcommand{\skappaCth}{\kappa_{\textrm{C}13\subctp}} % concentration constants for low  tanks
\newcommand{\vkappaR}{\vector{\kappa}_{\textrm{R}\subc}} % vectors of concentration constants
\newcommand{\vkappaC}{\vector{\kappa}_{\textrm{C}\subctp}} % vectors of concentration constants
% corrected
\newcommand{\skappaRtwp}{\skappaRtw^{\prime}} % concentration constants for high tanks
\newcommand{\skappaRthp}{\skappaRth^{\prime}} % concentration constants for high tanks
\newcommand{\skappaCtwp}{\skappaCtw^{\prime}} % concentration constants for low  tanks
\newcommand{\skappaCthp}{\skappaCth^{\prime}} % concentration constants for low  tanks
\newcommand{\vkappaRp}{\vkappaR^{\prime}} % vectors of concentration constants
\newcommand{\vkappaCp}{\vkappaC^{\prime}} % vectors of concentration constants
% gain offset
\newcommand{\sgtw}{g_{\textrm{12}\subctp}} % gain
\newcommand{\sgth}{g_{\textrm{13}\subctp}} % gain
\newcommand{\sotw}{o_{\textrm{12}\subctp}} % offset
\newcommand{\soth}{o_{\textrm{13}\subctp}} % offset
 % data
 \newcommand{\vdatakappaH}{\data{\vector{\kappa}}_{\textrm{H}\subctpr}} %
 \newcommand{\vdatakappaL}{\data{\vector{\kappa}}_{\textrm{L}\subctpr}} %
 \newcommand{\vdatakappaR}{\data{\vector{\kappa}}_{\textrm{R}\subctpr}} %
 \newcommand{\vdatakappaC}{\data{\vector{\kappa}}_{\textrm{C}\subctpr}} %
 \newcommand{\sdatakappaHtw}{\data{\kappa}_{\textrm{H}12\subctpr}} %
 \newcommand{\sdatakappaHth}{\data{\kappa}_{\textrm{H}13\subctpr}} %
 \newcommand{\sdatakappaLtw}{\data{\kappa}_{\textrm{L}12\subctpr}} %
 \newcommand{\sdatakappaLth}{\data{\kappa}_{\textrm{L}13\subctpr}} %
 \newcommand{\sdatakappaRtw}{\data{\kappa}_{\textrm{R}12\subctpr}} %
 \newcommand{\sdatakappaRth}{\data{\kappa}_{\textrm{R}13\subctpr}} %
 \newcommand{\sdatakappaCtw}{\data{\kappa}_{\textrm{C}12\subctpr}} %
 \newcommand{\sdatakappaCth}{\data{\kappa}_{\textrm{C}13\subctpr}} %
 \newcommand{\vsigkappaH}{\vdatasig{\vector{\kappa}_{\textrm{H}}}} %
 \newcommand{\vsigkappaL}{\vdatasig{\vector{\kappa}_{\textrm{L}}}} %
 \newcommand{\vsigkappaR}{\vdatasig{\vector{\kappa}_{\textrm{R}}}} %
 \newcommand{\vsigkappaC}{\vdatasig{\vector{\kappa}_{\textrm{C}}}} %

%
\newcommand{\sAL}{A_{\subctp}} % photosynthesis from Licor
 \newcommand{\sdataAL}{\data{A}_{\subctpr}} % photosynthesis from Licor
 \newcommand{\ssigAL}{\sdatasig{A}} %

\newcommand{\sgm}{g_{\textrm{m}\subctp}} % internal conductance (simple)

\newcommand{\sE}{E_{\subctp}} %
 \newcommand{\sdataE}{\data{E}_{\subctpr}} %
 \newcommand{\ssigE}{\sdatasig{E}} %

\newcommand{\sgsc}{g_{\textrm{sc}}} %
 \newcommand{\sdotgsc}{\dot{g}_{\textrm{sc}}} %
 \renewcommand{\sgsc}{\sdotgsc} %

\newcommand{\sgbc}{g_{\textrm{bc}}} %
 \newcommand{\sdotgbc}{\dot{g}_{\textrm{bc}}} %
 \renewcommand{\sgbc}{\sdotgbc} %

\newcommand{\sgtc}{g_{\textrm{tc}\subctp}} %
 \newcommand{\sdatagtc}{\data{g}_{\textrm{tc}\subctpr}} %
 \newcommand{\ssiggtc}{\sdatasig{g_{\textrm{tc}}}} %
%% tdllicor end   %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



--------------------------------------------------------------------------------

# Installation

## Install R

R and Perl are required.  Rstudio may make your experience more enjoyable.

1. R (requires R 2.15.1+)

    1. Windows (http://cran.r-project.org/bin/windows/base/)
    1. Mac (http://cran.r-project.org/bin/macosx/)

1. Rstudio

    1. Rstudio (http://www.rstudio.org/download/) nicer GUI

1. Perl

    1. Mac and linux, you already have it installed
    1. Windows

        * http://www.activestate.com/activeperl/downloads
        * Change the path variable to include `C:\Perl\bin` (or whatever it is on your machine, and use backslashes): http://www.java.com/en/download/help/path.xml





## Install the isogasex and required packages

### Install the isogasex package

From the shared dropbox folder `./TDL_R_scripts/` install the current version of isogasex.

The package installation file will appear in a folder named something like

1. `./isogasex_0.1-21_20121017-R2.15.1-template4/`

and will include two files, such as

1. the package: `isogasex_0.1-21.tar.gz`
1. and the template: `isogasex_template4.xls`


There doesn't seem to be a way to install local packages within R anymore, so it has to be done from the command prompt.
From your shell or command prompt:

1. Windows, open your command prompt (cmd), change to directory with install file, and install it (you need to get the correct path, filename, and R command name).

    1. `cd C:\[your path]\TDL_R_scripts\isogasex_0.1-21_20121017-R2.15.1-template4`
    1. `"C:\Program Files\R\R-2.15.1\bin\x64\R" CMD INSTALL isogasex_0.1-21.tar.gz`

1. Mac, I can't walk you through this since I don't have access to a Mac right now, but it's similar, probably something like this:

    1. `cd ~/[your path]/TDL_R_scripts/isogasex_0.1-21_20121017-R2.15.1-template4`
    1. `R CMD INSTALL isogasex_0.1-21.tar.gz`


Copy the template file to your data directory before you rename and edit it.


### Install package dependencies

These should install automatically with the command above.
But if not, these commands will do it:
```
  XXX commands here
```

# Execution

_Try to avoid using spaces in your directory names (folder names) and file names._

Analyze your TDL and/or Licor data

1. Create a new data analysis directory, such as `./Name_WT001`
1. Copy your TDL and Licor files into your new dir
1. Copy the `isogasex_template4.xls` into your new dir
1. Append a meaningful suffix to the `.xls` file, such as `isogasex_template4_Name_WT001.xls`
1. Edit the `.xls` file and specify the TDL and Licor filenames, and make any other necessary changes to template inputs.
1. Load the library: (see end of doc for the remaining steps all together)

    1. `library(isogasex)`

1. Assign the xls filename to a variable

    1. `input.fn <- "isogasex_template4_Name_WT001.xls"`

1. Specify your new dir (using forward slashes for all systems is preferred)

    1. Mac, Linux:

        1. `path <- "/Users/username/Analysis/Name_WT001"`

    1. Windows:

        1. `path <- "C:/Dropbox/Analysis/Name_WT001"`


1. Run the analysis

    1. a.  `isogasex(input.fn, path)}

1. It will create an `./out` directory where output files are created.
1. Documentation is available with `?isogasex`

Use a block of code like this, set your file name and directory, and copy/paste into R.
```{r, eval=FALSE}
library(isogasex)
# ?isogasex
input.fn <- "isogasex_template4_Name_WT001.xls"
path <- "/Users/username/Analysis/Name_WT001" # Mac
path <- "C:/Dropbox/Analysis/Name_WT001"      # Windows
isogasex(input.fn, path)
```


# Gas exchange calculations

## Constants

While each of these values have their own associated uncertainty,
  we take them to be constant at their (accepted) values for an analysis.
Common values are included below, though these may be changed in the template.

$$
\begin{aligned}
\sdotab
  & \equiv & 2.96 \permil
  & \quad\textrm{boundary} \\
\sdota
  & \equiv & 4.44 \permil
  & \quad\textrm{stomata}  \\
\sdotaw
  & \equiv & \sdotal \equiv 0.7 \permil
  & \quad\textrm{water}    \\
\sdotbs
  & \equiv &  1.1 \permil
  & \quad\textrm{CO2 entering solution at 20$^\circ$ C} \\
\sdotb
  & \equiv &  29 \permil
  & \quad\textrm{internal conductance via gm} \\
\sdotRstd
  & \equiv &  0.0111797
  & \quad\textrm{C ratio of standard} \\
\vdotkappaHtw
  & \equiv &  (\sdotkappaHtw, \sdotkappaHth)  \equiv (473.3358029, 5.183209292)
  & \quad\textrm{concentration constants for high tanks} \\
\vdotkappaLtw
  & \equiv &  (\sdotkappaLtw, \sdotkappaLth)  \equiv (243.4737846, 2.666301131)
  & \quad\textrm{concentration constants for low  tanks} \\
\sdotfthC
  & \equiv &  0.004922
  & \quad\textrm{natural fractional abundance of C isotopologues not measured} \\
\sgbc
  & \equiv &  3
  & \quad\textrm{conductance at the boundary level, can also be obtained from Licor} \\
\end{aligned}
$$

```

## Data

### TDL

Concentrations for high and low calibration tanks (H and L),
  reference gas entering the chamber (R),
  and chamber gas exiting the chamber (C).

$\vdatakappaH = (\sdatakappaHtw,\sdatakappaHth)^\transpose$

$\vdatakappaL = (\sdatakappaLtw,\sdatakappaLth)^\transpose$

$\vdatakappaR = (\sdatakappaRtw,\sdatakappaRth)^\transpose$

$\vdatakappaC = (\sdatakappaCtw,\sdatakappaCth)^\transpose$


### Licor

$\sdatapatmL \sim \Normal(\spatmL,\ssigpatmL)$ atmospheric pressure from Licor

$\sdataAL \sim \Normal(\sAL, \ssigAL)$ photosynthesis from Licor (can also calculate from TDL)

$\sdatagtc \sim \Normal(\sgtc, \ssiggtc)$ total conductance of CO$_2$
  (I have a note that this is a function of $\sgbc$, $\sgsc$, $\sdotab$, $\sdotgsc$, and $\sdotgbc$.)

$\sdataE \sim \Normal(\sE, \ssigE)$ transpiration rate (water vapor)


## Calculations

### Concentration


Offset

$\sotw = \sdotkappaHtw - \sgtw\skappaHtw$

$\soth = \sdotkappaHth - \sgth\skappaHth$


Gain

$\sgtw = (\sdotkappaHtw - \sdotkappaLtw)(\skappaHtw - \skappaLtw)^{-1}$

$\sgth = (\sdotkappaHth - \sdotkappaLth)(\skappaHth - \skappaLth)^{-1}$


Corrected

$\skappaRtwp = \skappaRtw\sgtw + \sotw$ Ref

$\skappaRthp = \skappaRth\sgth + \soth$ Ref

$\skappaCtwp = \skappaCtw\sgtw + \sotw$ Chamber

$\skappaCthp = \skappaCth\sgth + \soth$ Chamber


xi

$\sxi=\sCe(\sCe-\sCo)^{-1}$


delta

$\sdeltae = \{ (\skappaRthp/\skappaRtwp)/\sdotRstd - 1 \} 10^3\permil$ Ref

$\sdeltao = \{ (\skappaCthp/\skappaCtwp)/\sdotRstd - 1 \} 10^3\permil$ Chamber


Total mol fractions (paired, either both Licor or both TDL)

$\sCe = (\skappaRtwp+\skappaRthp)(1-\sdotfthC)^{-1}$ entering Reference

$\sCa \equiv \sCo = (\skappaCtwp+\skappaCthp)(1-\sdotfthC)^{-1}$ outgoing Chamber



## Partial Pressures

$\spa = (\sCa 10^{-6})(\spatmL 10^3)$ atmosphere

$\sps = (\sCs 10^{-6})(\spatmL 10^3)$ surface

$\spi = (\sCi 10^{-6})(\spatmL 10^3)$ internal

$\spc = \spi - \sAL \sgm^{-1}$ (chloroplast) carboxylation site

$\sgm = (\sdotb - \sdotbs - \sdotaw)\sAL\spa^{-1}(\sDeltapred-\sDeltaobs)^{-1}$



### Discrimination

{\bf (can put priors here, if desired)}

$\sDeltaobs = \sxi(\sdeltao-\sdeltae)\{1+\sdeltao-\sxi(\sdeltao-\sdeltae)\}^{-1}10^3$

$\sDeltapred = \spa^{-1} \{ \sdotab(\spa-\sps) + \sdota(\sps-\spi) + \sdotb\spc \}$

(circular, assume $\spc\equiv\spi$)



Leaf surface:

$\sCs = \{ (\sgbc - \sE/2000)\sCo - \sAL \} ( \sgbc + \sE/2000 )^{-1}$

$\sCi = \{ (\sgtc - \sE/2000)\sCo - \sAL \} ( \sgtc + \sE/2000 )^{-1}$

Either of these valuse can be from the TDL or Licor: $\sCo$ and $\sAL$.
```
