---
title: "isogasex: Isotopic Gas Exchange"
subtitle: "R package documentation for TDL and Licor data processing"
author: "Erik B. Erhardt and David T. Hanson"
date: "`r format(Sys.time(), '%B %d, %Y')`"
header-includes:
   - \usepackage{amsmath,wasysym}
output:
  rmarkdown::html_vignette:
    fig_caption: yes
    toc: yes
    toc_depth: 5
    number_sections: true
  html_document:
    toc: yes
    toc_depth: 5
    number_sections: false
    code_folding: hide
  pdf_document:
    latex_engine: xelatex
    toc: yes
    toc_depth: 5
    number_sections: true
vignette: >
  %\VignetteIndexEntry{isogasex: Isotopic Gas Exchange}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography:
  EE_BayesCO2.bib
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

<!---
# Erik's compile commands in R:
  rm(list=ls())
  #dev.off(dev.list()["RStudioGD"])  # close all plots
  fn.this <- "isogasex_user_guide.Rmd"
  setwd("C:/Dropbox/StatAcumen/consult/Authorship/2009_DavidHanson_Isotopes/R-package/isogasex/vignettes")
  library(knitr)
  knitr::purl(fn.this)
  rmarkdown::render(fn.this)
-->

```{r ch_01, echo=FALSE}
knitr::opts_chunk$set(comment = NA, message = FALSE, warning = FALSE, width = 100)
knitr::opts_chunk$set(fig.align = "center", fig.height = 4, fig.width = 6)
#knitr::opts_chunk$set(echo = FALSE)
#knitr::opts_chunk$set(cache = TRUE, autodep=TRUE)  #$
#knitr::opts_chunk$set(cache = TRUE) #, autodep=TRUE)  #$
```

\newcommand{\defin}{\bf}
\renewcommand{\vector}{}
\renewcommand{\matrix}{\mathbf}
\renewcommand{\permil}{‰}
\renewcommand{\circ}{°}

\newcommand{\Normal}          {\textrm{Normal}}
\newcommand{\Wishart}         {\textrm{Wishart}}
\newcommand{\IWishart}        {\textrm{Inv-Wishart}}
\newcommand{\Chisq}           {\textrm{scaled-$\chi^2$}}
\newcommand{\IChisq}          {\textrm{Scaled-inv-$\chi^2$}}
\newcommand{\Dirichlet}       {\textrm{Dirichlet}}
\newcommand{\dBeta}           {\textrm{Beta}}
\newcommand{\dGamma}          {\textrm{Gamma}}
\newcommand{\dIGamma}         {\textrm{Inv-Gamma}}
\newcommand{\Uniform}         {\textrm{Uniform}}

\newcommand{\transpose}       {\top}

\newcommand{\isogasex}{\texttt{isogasex}}

\newcommand{\data}[1]{\tilde{#1}}
\newcommand{\sdatasig}[1]{\sigma_{#1}^2}
\newcommand{\vdatasig}[1]{\Sigma_{#1}}

\newcommand{\subctpr}{}
\newcommand{\subctp} {}
\newcommand{\subct}  {}
\newcommand{\subc}   {}
\newcommand{\subt}   {}




\newcommand{\sdotab}{\dot{a}_{\textrm{b}}}
\newcommand{\sdota}{\dot{a}}
\newcommand{\sdotaw}{\dot{a}_{\textrm{w}}}
\newcommand{\sdotal}{\dot{a}_{\textrm{l}}}
\newcommand{\sdotbs}{\dot{b}_{\textrm{s}}}
\newcommand{\sdotb}{\dot{b}}
\newcommand{\sdotRstd}{\dot{R}_\textrm{std 13C}}
\newcommand{\sdotkappaHtw}{\dot{\kappa}_{\textrm{H}12}}
\newcommand{\sdotkappaHth}{\dot{\kappa}_{\textrm{H}13}}
\newcommand{\sdotkappaLtw}{\dot{\kappa}_{\textrm{L}12}}
\newcommand{\sdotkappaLth}{\dot{\kappa}_{\textrm{L}13}}
\newcommand{\vdotkappaHtw}{\vector{\dot{\kappa}}_{\textrm{H}}}
\newcommand{\vdotkappaLtw}{\vector{\dot{\kappa}}_{\textrm{L}}}
\newcommand{\sdotfthC}{\dot{f}_{\textrm{13C}}}


\newcommand{\sDeltacomp}{\Delta_{\textrm{comp}\subct}}
\newcommand{\sDeltaobs}{\Delta_{\textrm{obs}\subct}}
\newcommand{\sDeltapred}{\Delta_{\textrm{pred}\subct}}


\newcommand{\spa}{p_{\textrm{a}\subct}}
\newcommand{\sps}{p_{\textrm{s}\subct}}
\newcommand{\spi}{p_{\textrm{i}\subct}}
\newcommand{\spc}{p_{\textrm{c}\subct}}
\newcommand{\spatmL}{p_{\textrm{atm}\subctp}}
\newcommand{\sallpressures}{\pi_{\subctp}}

 \newcommand{\sdatapatmL}{\data{p}_{\textrm{atm}\subctpr}}
 \newcommand{\ssigpatmL}{\sdatasig{p_{\textrm{atm}}}}


\newcommand{\sse}{e_{\subt}}
\newcommand{\sseprime}{e_{\subt}^{\prime}}
\newcommand{\sRd}{R_{\textrm{d}\subt}}

 \newcommand{\sdataRd}{\data{R}_{\textrm{d}\subctp}}
 \newcommand{\ssigRd}{\sdatasig{R_{\textrm{d}}}}
\newcommand{\ssk}{k_{\subt}}

 \newcommand{\sdatak}{\data{k}_{\subctp}}
 \newcommand{\ssigk}{\sdatasig{k_{\subct}}}
\newcommand{\ssf}{f_{\subct}}
\newcommand{\ssfprime}{f_{\subct}^{\prime}}
\newcommand{\sGammastar}{\Gamma^{\ast}_{\subt}}

 \newcommand{\sdataGammastar}{\data{\Gamma}^{\ast}_{\subt}}
 \newcommand{\ssigGammastar}{\sdatasig{\Gamma^{\ast}_{}}}


\newcommand{\sxi}{\xi_{\subctp}}
\newcommand{\sdeltao}{\delta_{\textrm{o}\subctp}}
\newcommand{\sdeltae}{\delta_{\textrm{e}\subctp}}


\newcommand{\sCa}{C_{\textrm{a}\subctp}}
\newcommand{\sCo}{C_{\textrm{o}\subctp}}
\newcommand{\sCs}{C_{\textrm{s}\subctp}}
\newcommand{\sCi}{C_{\textrm{i}\subctp}}
\newcommand{\sCe}{C_{\textrm{e}\subctp}}

\newcommand{\skappaHtw}{\kappa_{\textrm{H}12\subctp}}
\newcommand{\skappaHth}{\kappa_{\textrm{H}13\subctp}}
\newcommand{\skappaLtw}{\kappa_{\textrm{L}12\subctp}}
\newcommand{\skappaLth}{\kappa_{\textrm{L}13\subctp}}
\newcommand{\vkappaH}{\vector{\kappa}_{\textrm{H}\subctp}}
\newcommand{\vkappaL}{\vector{\kappa}_{\textrm{L}\subctp}}

\newcommand{\skappaRtw}{\kappa_{\textrm{R}12\subc}}
\newcommand{\skappaRth}{\kappa_{\textrm{R}13\subc}}
\newcommand{\skappaCtw}{\kappa_{\textrm{C}12\subctp}}
\newcommand{\skappaCth}{\kappa_{\textrm{C}13\subctp}}
\newcommand{\vkappaR}{\vector{\kappa}_{\textrm{R}\subc}}
\newcommand{\vkappaC}{\vector{\kappa}_{\textrm{C}\subctp}}

\newcommand{\skappaRtwp}{\skappaRtw^{\prime}}
\newcommand{\skappaRthp}{\skappaRth^{\prime}}
\newcommand{\skappaCtwp}{\skappaCtw^{\prime}}
\newcommand{\skappaCthp}{\skappaCth^{\prime}}
\newcommand{\vkappaRp}{\vkappaR^{\prime}}
\newcommand{\vkappaCp}{\vkappaC^{\prime}}

\newcommand{\sgtw}{g_{\textrm{12}\subctp}}
\newcommand{\sgth}{g_{\textrm{13}\subctp}}
\newcommand{\sotw}{o_{\textrm{12}\subctp}}
\newcommand{\soth}{o_{\textrm{13}\subctp}}

 \newcommand{\vdatakappaH}{\data{\vector{\kappa}}_{\textrm{H}\subctpr}}
 \newcommand{\vdatakappaL}{\data{\vector{\kappa}}_{\textrm{L}\subctpr}}
 \newcommand{\vdatakappaR}{\data{\vector{\kappa}}_{\textrm{R}\subctpr}}
 \newcommand{\vdatakappaC}{\data{\vector{\kappa}}_{\textrm{C}\subctpr}}
 \newcommand{\sdatakappaHtw}{\data{\kappa}_{\textrm{H}12\subctpr}}
 \newcommand{\sdatakappaHth}{\data{\kappa}_{\textrm{H}13\subctpr}}
 \newcommand{\sdatakappaLtw}{\data{\kappa}_{\textrm{L}12\subctpr}}
 \newcommand{\sdatakappaLth}{\data{\kappa}_{\textrm{L}13\subctpr}}
 \newcommand{\sdatakappaRtw}{\data{\kappa}_{\textrm{R}12\subctpr}}
 \newcommand{\sdatakappaRth}{\data{\kappa}_{\textrm{R}13\subctpr}}
 \newcommand{\sdatakappaCtw}{\data{\kappa}_{\textrm{C}12\subctpr}}
 \newcommand{\sdatakappaCth}{\data{\kappa}_{\textrm{C}13\subctpr}}
 \newcommand{\vsigkappaH}{\vdatasig{\vector{\kappa}_{\textrm{H}}}}
 \newcommand{\vsigkappaL}{\vdatasig{\vector{\kappa}_{\textrm{L}}}}
 \newcommand{\vsigkappaR}{\vdatasig{\vector{\kappa}_{\textrm{R}}}}
 \newcommand{\vsigkappaC}{\vdatasig{\vector{\kappa}_{\textrm{C}}}}


\newcommand{\sAL}{A_{\subctp}}
 \newcommand{\sdataAL}{\data{A}_{\subctpr}}
 \newcommand{\ssigAL}{\sdatasig{A}}

\newcommand{\sgm}{g_{\textrm{m}\subctp}}

\newcommand{\sE}{E_{\subctp}}
 \newcommand{\sdataE}{\data{E}_{\subctpr}}
 \newcommand{\ssigE}{\sdatasig{E}}

\newcommand{\sgsc}{g_{\textrm{sc}}}
 \newcommand{\sdotgsc}{\dot{g}_{\textrm{sc}}}
 \renewcommand{\sgsc}{\sdotgsc}

\newcommand{\sgbc}{g_{\textrm{bc}}}
 \newcommand{\sdotgbc}{\dot{g}_{\textrm{bc}}}
 \renewcommand{\sgbc}{\sdotgbc}

\newcommand{\sgtc}{g_{\textrm{tc}\subctp}}
 \newcommand{\sdatagtc}{\data{g}_{\textrm{tc}\subctpr}}
 \newcommand{\ssiggtc}{\sdatasig{g_{\textrm{tc}}}}




--------------------------------------------------------------------------------

# Installation

## Install R

R and Perl are required.  Rstudio may make your experience more enjoyable.

1. R (requires R 2.15.1+)

    1. Windows (http://cran.r-project.org/bin/windows/base/)
    1. Mac (http://cran.r-project.org/bin/macosx/)

1. Rstudio

    1. Rstudio (http://www.rstudio.org/download/) nicer GUI

1. Perl

    1. Mac and linux, you already have it installed
    1. Windows

        * http://www.activestate.com/activeperl/downloads
        * Change the path variable to include `C:\Perl\bin` (or whatever it is on your machine, and use backslashes): http://www.java.com/en/download/help/path.xml





## Install the isogasex and required packages

### Install the isogasex package

From the shared dropbox folder `./TDL_R_scripts/` install the current version of isogasex.

The package installation file will appear in a folder named something like

1. `./isogasex_0.1-21_20121017-R2.15.1-template4/`

and will include two files, such as

1. the package: `isogasex_0.1-21.tar.gz`
1. and the template: `isogasex_template4.xls`


There doesn't seem to be a way to install local packages within R anymore, so it has to be done from the command prompt.
From your shell or command prompt:

1. Windows, open your command prompt (cmd), change to directory with install file, and install it (you need to get the correct path, filename, and R command name).

    1. `cd C:\[your path]\TDL_R_scripts\isogasex_0.1-21_20121017-R2.15.1-template4`
    1. `"C:\Program Files\R\R-2.15.1\bin\x64\R" CMD INSTALL isogasex_0.1-21.tar.gz`

1. Mac, I can't walk you through this since I don't have access to a Mac right now, but it's similar, probably something like this:

    1. `cd ~/[your path]/TDL_R_scripts/isogasex_0.1-21_20121017-R2.15.1-template4`
    1. `R CMD INSTALL isogasex_0.1-21.tar.gz`


Copy the template file to your data directory before you rename and edit it.


### Install package dependencies

These should install automatically with the command above.
But if not, these commands will do it:
```
  XXX commands here
```

# Execution

_Try to avoid using spaces in your directory names (folder names) and file names._

Analyze your TDL and/or Licor data

1. Create a new data analysis directory, such as `./Name_WT001`
1. Copy your TDL and Licor files into your new dir
1. Copy the `isogasex_template4.xls` into your new dir
1. Append a meaningful suffix to the `.xls` file, such as `isogasex_template4_Name_WT001.xls`
1. Edit the `.xls` file and specify the TDL and Licor filenames, and make any other necessary changes to template inputs.
1. Load the library: (see end of doc for the remaining steps all together)

    1. `library(isogasex)`

1. Assign the xls filename to a variable

    1. `input.fn <- "isogasex_template4_Name_WT001.xls"`

1. Specify your new dir (using forward slashes for all systems is preferred)

    1. Mac, Linux:

        1. `path <- "/Users/username/Analysis/Name_WT001"`

    1. Windows:

        1. `path <- "C:/Dropbox/Analysis/Name_WT001"`


1. Run the analysis

    1. a.  `isogasex(input.fn, path)}

1. It will create an `./out` directory where output files are created.
1. Documentation is available with `?isogasex`

Use a block of code like this, set your file name and directory, and copy/paste into R.
```{r, eval=FALSE}
library(isogasex)
# ?isogasex
input.fn <- "isogasex_template4_Name_WT001.xls"
path <- "/Users/username/Analysis/Name_WT001" # Mac
path <- "C:/Dropbox/Analysis/Name_WT001"      # Windows
isogasex(input.fn, path)
```


# Gas exchange calculations

## Constants

While each of these values have their own associated uncertainty,
  we take them to be constant at their (accepted) values for an analysis.
Common values are included below, though these may be changed in the template.

$$
\begin{aligned}
\sdotab
  & \equiv & 2.96 \permil
  & \quad\textrm{boundary} \\
\sdota
  & \equiv & 4.44 \permil
  & \quad\textrm{stomata}  \\
\sdotaw
  & \equiv & \sdotal \equiv 0.7 \permil
  & \quad\textrm{water}    \\
\sdotbs
  & \equiv &  1.1 \permil
  & \quad\textrm{CO2 entering solution at 20$^\circ$ C} \\
\sdotb
  & \equiv &  29 \permil
  & \quad\textrm{internal conductance via gm} \\
\sdotRstd
  & \equiv &  0.0111797
  & \quad\textrm{C ratio of standard} \\
\vdotkappaHtw
  & \equiv &  (\sdotkappaHtw, \sdotkappaHth)  \equiv (473.3358029, 5.183209292)
  & \quad\textrm{concentration constants for high tanks} \\
\vdotkappaLtw
  & \equiv &  (\sdotkappaLtw, \sdotkappaLth)  \equiv (243.4737846, 2.666301131)
  & \quad\textrm{concentration constants for low  tanks} \\
\sdotfthC
  & \equiv &  0.004922
  & \quad\textrm{natural fractional abundance of C isotopologues not measured} \\
\sgbc
  & \equiv &  3
  & \quad\textrm{conductance at the boundary level, can also be obtained from Licor} \\
\end{aligned}
$$


## Data

### TDL

Concentrations for high and low calibration tanks (H and L),
  reference gas entering the chamber (R),
  and chamber gas exiting the chamber (C).

$$
\begin{aligned}
\vdatakappaH
  & = & (\sdatakappaHtw,\sdatakappaHth)^\transpose
  & \quad \\
\vdatakappaL
  & = & (\sdatakappaLtw,\sdatakappaLth)^\transpose
  & \quad  \\
\vdatakappaR
  & = & (\sdatakappaRtw,\sdatakappaRth)^\transpose
  & \quad  \\
\vdatakappaC
  & = & (\sdatakappaCtw,\sdatakappaCth)^\transpose
  & \quad  \\
\end{aligned}
$$



### Licor


$$
\begin{aligned}
\sdatapatmL
  & \sim & \Normal(\spatmL,\ssigpatmL)
  & \quad \textrm{atmospheric pressure from Licor} \\
\sdataAL
  & \sim & \Normal(\sAL, \ssigAL)
  & \quad \textrm{photosynthesis from Licor (can also calculate from TDL)} \\
\sdatagtc
  & \sim & \Normal(\sgtc, \ssiggtc)
  & \quad \textrm{total conductance of CO_2} \\
\sdataE
  & \sim & \Normal(\sE, \ssigE)
  & \quad \textrm{transpiration rate (water vapor)} \\
\end{aligned}
$$

I have a note that $\sdatagtc$ is a function of $\sgbc$, $\sgsc$, $\sdotab$, $\sdotgsc$, and $\sdotgbc$.

## Calculations

### Concentration


Offset

$$
\begin{aligned}
\sotw
  & = & \sdotkappaHtw - \sgtw\skappaHtw
  & \quad \textrm{} \\
\soth
  & = & \sdotkappaHth - \sgth\skappaHth
  & \quad \textrm{} \\
\end{aligned}
$$


Gain

$$
\begin{aligned}
\sgtw
  & = & (\sdotkappaHtw - \sdotkappaLtw)(\skappaHtw - \skappaLtw)^{-1}
  & \quad \textrm{} \\
\sgth
  & = & (\sdotkappaHth - \sdotkappaLth)(\skappaHth - \skappaLth)^{-1}
  & \quad \textrm{} \\
\end{aligned}
$$


Corrected

$$
\begin{aligned}
\skappaRtwp
  & = & \skappaRtw\sgtw + \sotw
  & \quad \textrm{Ref} \\
\skappaRthp
  & = & \skappaRth\sgth + \soth
  & \quad \textrm{Ref} \\
\skappaCtwp
  & = & \skappaCtw\sgtw + \sotw
  & \quad \textrm{Chamber} \\
\skappaCthp
  & = & \skappaCth\sgth + \soth
  & \quad \textrm{Chamber} \\
\end{aligned}
$$


xi

$$
\begin{aligned}
\sxi
  & = & \sCe(\sCe-\sCo)^{-1}
  & \quad \textrm{} \\
\end{aligned}
$$


delta

$$
\begin{aligned}
\sdeltae
  & = & \{ (\skappaRthp/\skappaRtwp)/\sdotRstd - 1 \} 10^3\permil
  & \quad \textrm{Ref} \\
\sdeltao
  & = & \{ (\skappaCthp/\skappaCtwp)/\sdotRstd - 1 \} 10^3\permil
  & \quad \textrm{Chamber} \\
\end{aligned}
$$


Total mol fractions (paired, either both Licor or both TDL)

$$
\begin{aligned}
\sCe
  & = (& \skappaRtwp+\skappaRthp)(1-\sdotfthC)^{-1}
  & \quad \textrm{entering Reference} \\
\sCa
  & \equiv & \sCo = (\skappaCtwp+\skappaCthp)(1-\sdotfthC)^{-1}
  & \quad \textrm{outgoing Chamber} \\
\end{aligned}
$$



## Partial Pressures

$$
\begin{aligned}
\spa
  & = & (\sCa 10^{-6})(\spatmL 10^3)
  & \quad \textrm{atmosphere} \\
\sps
  & = & (\sCs 10^{-6})(\spatmL 10^3)
  & \quad \textrm{surface} \\
\spi
  & = & (\sCi 10^{-6})(\spatmL 10^3)
  & \quad \textrm{internal} \\
\spc
  & = & \spi - \sAL \sgm^{-1}
  & \quad \textrm{(chloroplast) carboxylation site} \\
\sgm
  & = & (\sdotb - \sdotbs - \sdotaw)\sAL\spa^{-1}(\sDeltapred-\sDeltaobs)^{-1}
  & \quad \textrm{}\\
\end{aligned}
$$



### Discrimination

{\bf (can put priors here, if desired)}

$$
\begin{aligned}
\sDeltaobs
  & = & \sxi(\sdeltao-\sdeltae)\{1+\sdeltao-\sxi(\sdeltao-\sdeltae)\}^{-1}10^3
  & \quad \textrm{}\\
\sDeltapred
  & = & \spa^{-1} \{ \sdotab(\spa-\sps) + \sdota(\sps-\spi) + \sdotb\spc \}
  & \quad \textrm{}\\
\end{aligned}
$$

(circular, assume $\spc \equiv \spi$)



Leaf surface:

$$
\begin{aligned}
\sCs
  & = & \{ (\sgbc - \sE/2000)\sCo - \sAL \} ( \sgbc + \sE/2000 )^{-1}
  & \quad \textrm{}\\
\sCi
  & = & \{ (\sgtc - \sE/2000)\sCo - \sAL \} ( \sgtc + \sE/2000 )^{-1}
  & \quad \textrm{}\\
\end{aligned}
$$

Either of these values can be from the TDL or Licor: $\sCo$ and $\sAL$.
